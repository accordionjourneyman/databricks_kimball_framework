table_name: {{ env }}_gold.dim_customer
table_type: dimension
scd_type: 2
keys:
  surrogate_key: customer_sk
  natural_keys: [customer_id]

# New configuration for surrogate key strategy
# SCD2 requires identity strategy; hash violates Kimball principles for versioned dimensions
surrogate_key_strategy: identity  # Options: identity, hash (SCD1 only), sequence

# Columns that trigger a new SCD2 version when changed
track_history_columns: 
  - first_name
  - last_name
  - email
  - address

# Optional: Business-time SCD2 - use source timestamp for __valid_from/__valid_to
# If not set, uses processing time (__etl_processed_at)
# effective_at: updated_at

# Default rows to seed into the dimension
default_rows:
  "-1": "Unknown"
  "-2": "N/A"

# Liquid Clustering for optimal query performance
cluster_by: [customer_id]
optimize_after_merge: true

sources:
  - name: {{ env }}_silver.customers
    alias: c
    cdc_strategy: cdf
    primary_keys: [customer_id]  # Required for CDF deduplication

transformation_sql: |
  SELECT
    c.customer_id,
    c.first_name,
    c.last_name,
    c.email,
    c.address,
    c.updated_at,
    c._change_type  -- Required for CDF delete detection
  FROM c

audit_columns: true
